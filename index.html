<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracking Link Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-gray-900 flex items-center">
        <i class="fas fa-map-marker-alt text-indigo-600 mr-2"></i> Link Tracker
      </h1>
    </div>
  </header>

  <main class="flex-grow max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <section class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Create a Tracking Link</h2>
      <form id="linkForm" class="space-y-6">
        <div>
          <label for="targetUrl" class="block text-sm font-medium text-gray-700 mb-1">Target URL</label>
          <input
            type="url"
            id="targetUrl"
            name="targetUrl"
            placeholder="https://example.com"
            required
            class="block w-full rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          />
        </div>
        <div>
          <label for="linkName" class="block text-sm font-medium text-gray-700 mb-1">Link Name (optional)</label>
          <input
            type="text"
            id="linkName"
            name="linkName"
            placeholder="My Campaign Link"
            class="block w-full rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          />
        </div>
        <button
          type="submit"
          class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          <i class="fas fa-link mr-2"></i> Generate Tracking Link
        </button>
      </form>
    </section>

    <section id="generatedSection" class="mt-10 hidden">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Tracking Link</h2>
      <div class="bg-white rounded-lg shadow p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <input
          type="text"
          id="generatedLink"
          readonly
          class="w-full sm:flex-1 rounded-md border border-gray-300 px-3 py-2 text-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm mb-4 sm:mb-0"
        />
        <button
          id="copyBtn"
          class="ml-0 sm:ml-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          <i class="fas fa-copy mr-2"></i> Copy Link
        </button>
      </div>
    </section>

    <section id="trackingDataSection" class="mt-10 hidden">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Tracking Data</h2>
      <div class="overflow-x-auto bg-white rounded-lg shadow p-4 max-h-96">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-4 py-2 text-left font-medium text-gray-700">Timestamp</th>
              <th class="px-4 py-2 text-left font-medium text-gray-700">IP Address</th>
              <th class="px-4 py-2 text-left font-medium text-gray-700">City</th>
              <th class="px-4 py-2 text-left font-medium text-gray-700">Region</th>
              <th class="px-4 py-2 text-left font-medium text-gray-700">Country</th>
              <th class="px-4 py-2 text-left font-medium text-gray-700">User Agent</th>
            </tr>
          </thead>
          <tbody id="trackingTableBody" class="divide-y divide-gray-100 max-h-80 overflow-y-auto"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="bg-white shadow mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-500 text-sm">
      &copy; 2024 Link Tracker. All rights reserved.
    </div>
  </footer>

  <script>
    // Simple in-memory storage for tracking data and links
    // In a real app, this would be a backend with a database.
    const trackingDataStore = {};
    const linkStore = {};

    // Generate a random short ID for tracking links
    function generateId(length = 8) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // Save tracking data for a given link ID
    function saveTrackingData(linkId, data) {
      if (!trackingDataStore[linkId]) {
        trackingDataStore[linkId] = [];
      }
      trackingDataStore[linkId].push(data);
    }

    // Format date to readable string
    function formatDate(date) {
      return new Date(date).toLocaleString();
    }

    // Copy text to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Link copied to clipboard!');
      });
    }

    // Create the tracking URL that points to the redirect page with tracking
    function createTrackingUrl(id) {
      // The redirect page is embedded in this app as a separate route (#/r/{id})
      // For demo, we use the current origin + #/r/{id}
      return `${window.location.origin}${window.location.pathname}#/r/${id}`;
    }

    // Render tracking data table for a given link ID
    function renderTrackingData(linkId) {
      const tbody = document.getElementById('trackingTableBody');
      tbody.innerHTML = '';
      const data = trackingDataStore[linkId] || [];
      if (data.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'px-4 py-2 text-center text-gray-500';
        td.textContent = 'No tracking data yet.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      data.forEach((item) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-2 whitespace-nowrap">${formatDate(item.timestamp)}</td>
          <td class="px-4 py-2 whitespace-nowrap">${item.ip || 'N/A'}</td>
          <td class="px-4 py-2 whitespace-nowrap">${item.city || 'N/A'}</td>
          <td class="px-4 py-2 whitespace-nowrap">${item.region || 'N/A'}</td>
          <td class="px-4 py-2 whitespace-nowrap">${item.country || 'N/A'}</td>
          <td class="px-4 py-2 break-words max-w-xs">${item.userAgent || 'N/A'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Handle form submission to create a tracking link
    document.getElementById('linkForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const targetUrl = e.target.targetUrl.value.trim();
      if (!targetUrl) return alert('Please enter a valid target URL.');

      const linkName = e.target.linkName.value.trim() || null;
      const id = generateId();

      // Save the link info
      linkStore[id] = {
        targetUrl,
        linkName,
        createdAt: Date.now(),
      };

      // Show the generated link
      const generatedLink = createTrackingUrl(id);
      const generatedSection = document.getElementById('generatedSection');
      const generatedLinkInput = document.getElementById('generatedLink');
      generatedLinkInput.value = generatedLink;
      generatedSection.classList.remove('hidden');

      // Show tracking data section
      const trackingDataSection = document.getElementById('trackingDataSection');
      trackingDataSection.classList.remove('hidden');

      // Render empty tracking data table
      renderTrackingData(id);

      // Save current link id in a data attribute for tracking data updates
      generatedSection.setAttribute('data-current-id', id);
      trackingDataSection.setAttribute('data-current-id', id);
    });

    // Copy button functionality
    document.getElementById('copyBtn').addEventListener('click', () => {
      const link = document.getElementById('generatedLink').value;
      if (link) {
        copyToClipboard(link);
      }
    });

    // Router to handle redirect links with tracking
    function router() {
      const hash = window.location.hash;
      if (hash.startsWith('#/r/')) {
        // This is a tracking redirect link
        const id = hash.split('/')[2];
        if (!id || !linkStore[id]) {
          document.body.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
              <div class="bg-white p-8 rounded-lg shadow max-w-md text-center">
                <h1 class="text-2xl font-semibold text-red-600 mb-4">Invalid Tracking Link</h1>
                <p class="text-gray-700 mb-6">The tracking link you followed is invalid or expired.</p>
                <a href="/" class="inline-block px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Go Home</a>
              </div>
            </div>
          `;
          return;
        }

        // Show a loading screen while we get location info
        document.body.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center bg-gray-50 px-4 text-center">
            <img src="https://placehold.co/100x100/png?text=Loading" alt="Loading spinner icon with circular motion lines" class="mb-6 animate-spin" />
            <p class="text-gray-700 text-lg">Redirecting and tracking your visit...</p>
          </div>
        `;

        // Collect visitor info
        const userAgent = navigator.userAgent;

        // Get IP and location info from a public API
        fetch('https://ipapi.co/json/')
          .then((res) => res.json())
          .then((locationData) => {
            const trackingInfo = {
              timestamp: Date.now(),
              ip: locationData.ip || 'N/A',
              city: locationData.city || 'N/A',
              region: locationData.region || 'N/A',
              country: locationData.country_name || 'N/A',
              userAgent,
            };
            saveTrackingData(id, trackingInfo);

            // Redirect to the target URL after a short delay
            setTimeout(() => {
              window.location.href = linkStore[id].targetUrl;
            }, 1500);
          })
          .catch(() => {
            // If API fails, still save minimal info and redirect
            saveTrackingData(id, {
              timestamp: Date.now(),
              ip: 'N/A',
              city: 'N/A',
              region: 'N/A',
              country: 'N/A',
              userAgent,
            });
            setTimeout(() => {
              window.location.href = linkStore[id].targetUrl;
            }, 1500);
          });
      } else {
        // Normal app view, render tracking data if a link is selected
        const generatedSection = document.getElementById('generatedSection');
        const trackingDataSection = document.getElementById('trackingDataSection');
        if (generatedSection.hasAttribute('data-current-id')) {
          const currentId = generatedSection.getAttribute('data-current-id');
          renderTrackingData(currentId);
        }
      }
    }

    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
  </script>
</body>
</html>